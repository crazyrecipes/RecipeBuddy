<!DOCTYPE html>
<html>
    <head>
        <title>View Recipe - RecipeBuddy</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="navbar">
            <a href="index.html"><div class="navbar_item">Home</div></a>
            <a href="list.html"><div class="navbar_item">My Recipes</div></a>
            <a href="search.html"><div class="navbar_item">Search</div></a>
            <a href="create.html"><div class="navbar_item">Create</div></a>
            <a href="pantry.html"><div class="navbar_item">Pantry</div></a>
            <a href="settings.html"><div class="navbar_item">Settings</div></a>
        </div>


        <div class="app_main">
            <img class="logo" src="media/recipebuddy.png">

            <div class="content_container">
                <div class="content_inner">
                    <div id="RECIPE_CONTENT"></div>
                </div>
            </div>
            <div class="timer">
                <input class="timer_field" id="RECIPE_TIMER" placeholder="00:00:00"><br>
                <button class="inline_button" onclick="start_timer()">Start</button>
                <button class="inline_button" onclick="stop_timer()">Stop</button>
            </div>
        </div>

        <div class="" id="TOAST_MESSAGE"></div>

        <script>
            /* API url to get single recipe from */
            const params = new URLSearchParams(decodeURI(window.location.search));
            const RECIPE_URL = "api/recipe/" + params.get("id");
            var timer_interval;
            var timer_value;


            /* ===== TOAST MESSAGE ===== */
            var toast_timeout;
            /* Show toast message */
            function show_toast(message) {
                clearTimeout(toast_timeout);
                var td = document.getElementById("TOAST_MESSAGE");
                td.innerHTML = message;
                td.className = "show";
                toast_timeout = setTimeout(hide_toast, 2900);
            }
            /* Hide toast message */
            function hide_toast() {
                var td = document.getElementById("TOAST_MESSAGE");
                td.className = td.className.replace("show", "hide");
            }
            /* ===== END TOAST MESSAGE ===== */
            
            /* Hours:minutes:seconds to seconds */
            function hms_to_s(hms) {
                let h = parseInt(hms.split(":")[0]);
                let m = parseInt(hms.split(":")[1]);
                let s = parseInt(hms.split(":")[2]);
                console.log(`h: ${h}, m: ${m}, s: ${s}`);
                return h * 3600 + m * 60 + s;
            }
            
            /* Seconds to hours:minutes:seconds */
            function s_to_hms(ts) {
                let h = Math.floor(ts / 3600).toString().padStart(2, '0');
                let m = Math.floor((ts % 3600) / 60).toString().padStart(2, '0');
                let s = Math.floor((ts % 3600) % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            }

            /* Check if a word is a valid time */
            function is_time(word) {
                s_word = word.replace(/[^a-zA-Z0-9:]/g, '');
                let r = new RegExp("^[0-9][0-9]:[0-5][0-9]:[0-5][0-9]$");
                return r.test(s_word);
            }

            /* Set timer */
            function set_timer(hms) {
                console.log("Setting timer... to " + hms);
                timer_value = hms_to_s(hms);
                console.log(timer_value);
                display_timer();
                show_toast(`Set timer to ${hms}`);
            }

            /* Update timer display */
            function display_timer() {
                document.getElementById("RECIPE_TIMER").value = s_to_hms(timer_value);
            }

            /* Start timer */
            function start_timer() {
                set_timer(document.getElementById("RECIPE_TIMER").value);
                timer_interval = setInterval(tick_timer, 1000);
                show_toast("Started timer.");
            }

            /* Stop timer */
            function stop_timer() {
                clearInterval(timer_interval);
                show_toast("Stopped timer.");
            }

            /* Tick timer */
            function tick_timer() {
                timer_value -= 1;
                if(timer_value < 1) {
                    show_toast("Time's up!");
                    window.alert("Time's up!");
                    clearInterval(timer_interval);
                }
                display_timer();
            }

            /* Grab a single recipe and display it */
            function display_recipe() {
                console.log(`Handle DISPLAY recipe ${RECIPE_URL}...`);
                fetch(RECIPE_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    console.log(data);

                    for(i in data.steps) {
                        console.log(data.steps[i]);
                        j = data.steps[i].split(" ");
                        console.log(j);
                        for(k in j) {
                            console.log(j[k]);
                            if(is_time(j[k])) {
                                console.log("HIT!");
                                data.steps[i] += `&nbsp<button onclick="set_timer('${j[k]}')">Set Timer</button>`;
                            }
                        }
                    }

                    recipe_ingredients = data.ingredients.join("<br>");
                    recipe_utensils = data.utensils.join("<br>");
                    recipe_steps = data.steps.join("<br>");
                    recipe_allergens = data.allergens.join("<br>");
                    recipe_tags = data.tags.join(",");
                    
                    var recipeHTML = `
                        <img class="recipeviewer_photo" src="${data.photo}">
                        <h1>${data.name}</h1>
                        <p>${data.desc}</p>
                        <p>${data.rating}&#9733; - Cooked ${data.cooked} times.</p>
                        <div class="spacer"></div>
                        <h2>Ingredients</h2>
                        <p>${recipe_ingredients}</p>
                        <h2>Utensils</h2>
                        <p>${recipe_utensils}</p>
                        <h2>Steps</h2>
                        <p>${recipe_steps}</p>
                        <h2>Tags</h2>
                        <p>${recipe_tags}</p>
                        <h2>Allergens</h2>
                        <p>${recipe_allergens}</p>
                        <a href="editor.html?id=${data.id}"><div class="inline_button">Edit this recipe</div></a>
                    `
                    document.getElementById("RECIPE_CONTENT").innerHTML = recipeHTML;
                }).catch(error => {
                    console.log(error);
                    window.alert("Error encountered! Please check the console for more details.");
                });
            }

            /* ===== On page load: ===== */
            display_recipe();

        </script>
    </body>
</html>
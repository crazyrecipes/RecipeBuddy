<!DOCTYPE html>
<html>
    <head>
        <title>View Recipe - RecipeBuddy</title>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" type="image/png" href="media/favicon.png">
    </head>
    <body>
        <div class="navbar_container">
            <div class="navbar">
                <a href="list.html"><div class="navbar_item">Home</div></a>
                <a href="search.html"><div class="navbar_item">Search</div></a>
                <a href="create.html"><div class="navbar_item">Create</div></a>
                <a href="pantry.html"><div class="navbar_item">Pantry</div></a>
                <a href="settings.html"><div class="navbar_item">Settings</div></a>
                <a href="help.html"><div class="navbar_item">Help</div></a>
            </div>
        </div>


        <div class="app_main">
            <img class="logo" src="media/recipebuddy.png">

            <div class="content_container">
                <div class="content_inner">
                    <div id="RECIPE_CONTENT"></div>
                </div>
            </div>
            <div class="timer">
                <input class="timer_field" id="RECIPE_TIMER" placeholder="00:00:00"><br>
                <button class="inline_button" onclick="start_timer()">Start</button>
                <button class="inline_button" onclick="stop_timer()">Stop</button>
            </div>
        </div>

        <div class="" id="TOAST_MESSAGE"></div>

        <script>
            /* API url to get single recipe from */
            const params = new URLSearchParams(decodeURI(window.location.search));
            const RECIPE_URL = "api/recipe/" + params.get("id");
            const COOK_URL = "api/cook/" + params.get("id");
            const PHOTO_URL = "api/photo/" + params.get("id");
            var timer_interval;
            var timer_value;


            /* ===== TOAST MESSAGE ===== */
            var toast_timeout;
            /* Show toast message */
            function show_toast(message) {
                clearTimeout(toast_timeout);
                var td = document.getElementById("TOAST_MESSAGE");
                td.innerHTML = message;
                td.className = "show";
                toast_timeout = setTimeout(hide_toast, 3000);
            }
            /* Hide toast message */
            function hide_toast() {
                var td = document.getElementById("TOAST_MESSAGE");
                td.className = td.className.replace("show", "hide");
            }
            /* ===== END TOAST MESSAGE ===== */
            
            /* ===== TIMER ===== */
            /* HH:MM:SS to s */
            function hms_to_s(hms) {
                let h = parseInt(hms.split(":")[0]);
                let m = parseInt(hms.split(":")[1]);
                let s = parseInt(hms.split(":")[2]);
                return h * 3600 + m * 60 + s;
            }
            /* Seconds to HH:MM:SS */
            function s_to_hms(ts) {
                let h = Math.floor(ts / 3600).toString().padStart(2, '0');
                let m = Math.floor((ts % 3600) / 60).toString().padStart(2, '0');
                let s = Math.floor((ts % 3600) % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            }
            /* MM:SS to seconds */
            function ms_to_s(hms) {
                let m = parseInt(hms.split(":")[0]);
                let s = parseInt(hms.split(":")[1]);
                return m * 60 + s;
            }
            /* Check if a word is a valid time in HH:MM:SS */
            function is_hms(word) {
                s_word = word.replace(/[^a-zA-Z0-9:]/g, '');
                let r = new RegExp("^[0-9][0-9]:[0-5][0-9]:[0-5][0-9]$");
                return r.test(s_word);
            }
            /* Check if a word is a valid time in MM:SS */
            function is_ms(word) {
                s_word = word.replace(/[^a-zA-Z0-9:]/g, '');
                let r = new RegExp("^[0-5][0-9]:[0-5][0-9]$");
                return r.test(s_word);
            }
            /* Check if a word is a valid time */
            function is_time(word) {
                return is_hms(word) || is_ms(word);
            }
            /* Time to seconds */
            function time_to_s(ts) {
                if(is_hms(ts)) {
                    return hms_to_s(ts);
                }
                if(is_ms(ts)) {
                    return ms_to_s(ts);
                }
                return 0;
            }

            /* Set timer */
            function set_timer(ts) {
                console.log("Setting timer... to " + ts);
                timer_value = time_to_s(ts);
                display_timer();
                show_toast(`Set timer to ${ts}`);
            }

            /* Update timer display */
            function display_timer() {
                document.getElementById("RECIPE_TIMER").value = s_to_hms(timer_value);
            }

            /* Start timer */
            function start_timer() {
                set_timer(document.getElementById("RECIPE_TIMER").value);
                timer_interval = setInterval(tick_timer, 1000);
                show_toast("Started timer.");
            }

            /* Stop timer */
            function stop_timer() {
                clearInterval(timer_interval);
                show_toast("Stopped timer.");
            }

            /* Tick timer */
            function tick_timer() {
                timer_value -= 1;
                if(timer_value < 1) {
                    var audio = new Audio("media/timer_done.mp3");
                    audio.play();
                    show_toast("Time's up!");
                    window.alert("Time's up!");
                    clearInterval(timer_interval);
                }
                display_timer();
            }

            /* Increment the recipe's cooked counter */
            function increment_cooked() {
                console.log(`Handle COOK for ${COOK_URL}...`);
                fetch(COOK_URL, {
                    method: "POST",
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("POST request failed!");
                    }
                    display_recipe();
                }).catch(error => {
                    console.log(error);
                    window.alert("Something went wrong displaying your recipe.");
                });
            }

            /* Grab a single recipe and display it */
            function display_recipe() {
                console.log(`Handle DISPLAY recipe ${RECIPE_URL}...`);
                fetch(RECIPE_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();

                    /* parse steps for times */
                    for(i in data.steps) {
                        j = data.steps[i].split(" ");
                        for(k in j) {
                            if(is_time(j[k])) {
                                //console.log("[DEBUG] Steps Parser: Found a time.");
                                data.steps[i] += `&nbsp<button class="timer_set_button" onclick="set_timer('${j[k]}')">Set Timer</button>`;
                            }
                        }
                    }

                    recipe_ingredients = data.ingredients.join("<br>");
                    recipe_utensils = data.utensils.join("<br>");
                    recipe_steps = data.steps.join("<br>");
                    recipe_allergens = data.allergens.join("<br>");
                    recipe_tags = data.tags.join(",");
                    let rating_disp = "";
                    for(i = 0; i < data.rating; i++) {
                        rating_disp += "&#9733 ";
                        if(i > 5) { break; }
                    }
                    
                    var recipeHTML = `
                        <img class="recipeviewer_photo" src="${PHOTO_URL}">
                        <h1>${data.name}</h1>
                        <p>${data.desc}</p>
                        <p>${rating_disp} - Cooked ${data.cooked} times.</p>
                        <div class="spacer"></div>
                        <h2>Ingredients</h2>
                        <p>${recipe_ingredients}</p>
                        <h2>Utensils</h2>
                        <p>${recipe_utensils}</p>
                        <h2>Steps</h2>
                        <p>${recipe_steps}</p>
                        <h2>Tags</h2>
                        <p>${recipe_tags}</p>
                        <h2>Allergens</h2>
                        <p>${recipe_allergens}</p>
                        <a href="editor.html?id=${data.id}"><div class="inline_button">Edit this recipe</div></a>
                        <button class="inline_button" onclick="increment_cooked()">I cooked this recipe</button>
                    `
                    document.getElementById("RECIPE_CONTENT").innerHTML = recipeHTML;
                }).catch(error => {
                    console.log(error);
                    window.alert("Something went wrong displaying your recipe.");
                });
            }

            /* ===== On page load: ===== */
            display_recipe();

        </script>
    </body>
</html>
<!DOCTYPE html>
<html>
    <head>
        <title>Settings - RecipeBuddy</title>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" type="image/png" href="media/favicon.png">
    </head>
    <body>
        <div class="navbar_container">
            <div class="navbar">
                <a href="list.html"><div class="navbar_item">Home</div></a>
                <a href="search.html"><div class="navbar_item">Search</div></a>
                <a href="create.html"><div class="navbar_item">Create</div></a>
                <a href="pantry.html"><div class="navbar_item">Pantry</div></a>
                <a href="settings.html"><div class="navbar_item">Settings</div></a>
                <a href="help.html"><div class="navbar_item">Help</div></a>
            </div>
        </div>

        <div class="app_main">
            <img class="logo" src="media/recipebuddy.png">
            <div class="content_container">
                <div class="content_inner">
                    <noscript><h1>You need to enable JavaScript for Recipebuddy to work!</h1></noscript>
                    <h1>Settings</h1>
                    <p>Select your allergens and back up your recipes here.</p>

                    <div class="spacer"></div>

                    <h2>My Allergens</h2>
                    <input type="checkbox" id="ALLERGEN_PEANUTS" name="ALLERGENS_INPUT" value="Peanuts">
                    <label for="ALLERGEN_PEANUTS">Peanuts</label><br>
                    <input type="checkbox" id="ALLERGEN_TREE_NUTS" name="ALLERGENS_INPUT" value="Tree Nuts">
                    <label for="ALLERGEN_TREE_NUTS">Tree Nuts</label><br>
                    <input type="checkbox" id="ALLERGEN_DAIRY" name="ALLERGENS_INPUT" value="Dairy">
                    <label for="ALLERGEN_DAIRY">Dairy</label><br>
                    <input type="checkbox" id="ALLERGEN_SOY" name="ALLERGENS_INPUT" value="Soy">
                    <label for="ALLERGEN_SOY">Soy</label><br>
                    <input type="checkbox" id="ALLERGEN_GLUTEN" name="ALLERGENS_INPUT" value="Gluten">
                    <label for="ALLERGEN_GLUTEN">Gluten</label><br>
                    <input type="checkbox" id="ALLERGEN_EGG" name="ALLERGENS_INPUT" value="Egg">
                    <label for="ALLERGEN_EGG">Egg</label><br>
                    <input type="checkbox" id="ALLERGEN_FISH" name="ALLERGENS_INPUT" value="Fish">
                    <label for="ALLERGEN_FISH">Fish</label><br>
                    <input type="checkbox" id="ALLERGEN_SHELLFISH" name="ALLERGENS_INPUT" value="Shellfish">
                    <label for="ALLERGEN_SHELLFISH">Shellfish</label><br>
                    <input type="checkbox" id="ALLERGEN_CORN" name="ALLERGENS_INPUT" value="Corn">
                    <label for="ALLERGEN_CORN">Corn</label><br>
                    <input type="checkbox" id="ALLERGEN_SESAME" name="ALLERGENS_INPUT" value="Sesame">
                    <label for="ALLERGEN_SESAME">Sesame</label><br>
                    <input type="checkbox" id="ALLERGEN_MUSTARD" name="ALLERGENS_INPUT" value="Mustard">
                    <label for="ALLERGEN_MUSTARD">Mustard</label><br>
                    <div class="inline_button" onclick="handle_allergen_change()">Update Allergens</div>
                    
                    <div class="spacer"></div>

                    <h2>Back up Recipes</h2>
                    <p>Click "Back Up Recipes" and copy the resulting text to somewhere safe.</p>
                    <textarea id="RECIPE_BACKUP_TEXT" class="text_field_big" rows="10" placeholder="Recipes will be exported here..."></textarea><br>
                    <div class="inline_button" onclick="handle_backup_recipes()">Back Up Recipes</div>
                    
                    <div class="spacer"></div>

                    <h2>Restore Recipes</h2>
                    <p>Paste your recipe backup JSON here and click "Restore Recipes".</p>
                    <p>This will update the information of recipes if they already exist or create new ones if they don't.</p>
                    <textarea id="RECIPE_RESTORE_TEXT" class="text_field_big" rows="10" placeholder="Paste recipes here to import..."></textarea><br>
                    <div class="inline_button" onclick="handle_restore_recipes()">Restore Recipes</div>
                    
                    <div class="spacer"></div>
                </div>
            </div>
        </div>

        <div class="toast" id="TOAST_MESSAGE"></div>

        <script>
            const ALLERGENS_URL = "api/allergens";
            const BACKUP_URL = "api/backup";
            const RESTORE_URL = "api/restore";

            /* ===== TOAST MESSAGE ===== */
            var toast_timeout;
            /* Show toast message */
            function show_toast(message) {
                clearTimeout(toast_timeout);
                var td = document.getElementById("TOAST_MESSAGE");
                td.innerHTML = message;
                td.className = "show";
                toast_timeout = setTimeout(hide_toast, 3000);
            }
            /* Hide toast message */
            function hide_toast() {
                var td = document.getElementById("TOAST_MESSAGE");
                td.className = td.className.replace("show", "hide");
            }
            /* ===== END TOAST MESSAGE ===== */

            /* Grab and display current user allergens */
            function display_allergens() {
                console.log("Handle DISPLAY allergens...");
                /* Send request */
                fetch(ALLERGENS_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    //console.log(data);
                    
                    var allergens_inputs = document.getElementsByName("ALLERGENS_INPUT");
                    for(let i in data) {
                        for(j = 0; j < allergens_inputs.length; j++) {
                            if(allergens_inputs[j].value === data[i]) {
                                allergens_inputs[j].checked = true;
                            }
                        }
                    }
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong displaying your allergens.");
                });
            }

            /* Push user allergen changes */
            function handle_allergen_change() {
                show_toast("Updating your allergens...");
                console.log("Handle UPDATE allergens...");
                var allergens_inputs = document.getElementsByName("ALLERGENS_INPUT");
                var user_allergens = [];
                for(i = 0; i < allergens_inputs.length; i++) {
                    if(allergens_inputs[i].checked) {
                        user_allergens.push(allergens_inputs[i].value);
                    }
                }
                console.log(`Updated allergens: "${user_allergens}"`);
                
                /* Send request */
                fetch(ALLERGENS_URL, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(user_allergens),
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("POST request failed!");
                    }
                    const data = await response.json();
                    //console.log(data);

                    /* Update display */
                    display_allergens();
                    show_toast("Updated allergens.");
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong updating your allergens.");
                });
            }
            
            /* Back up recipes to JSON */
            function handle_backup_recipes() {
                console.log("Handle BACKUP recipes...");
                show_toast("Backing up your recipes...");
                /* Send request */
                fetch(BACKUP_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    //console.log(data);
                    document.getElementById("RECIPE_BACKUP_TEXT").value = JSON.stringify(data);
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong backing up your recipes.");
                });
            }

            /* Restore recipes from JSON */
            function handle_restore_recipes() {
                console.log("Handle RESTORE recipes...");
                var recipes_json = document.getElementById("RECIPE_RESTORE_TEXT").value;

                show_toast("Restoring your recipes...");
                /* Send request */
                fetch(RESTORE_URL, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                    },
                    body: recipes_json,
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    //console.log(data);
                    show_toast("Restored your recipes successfully.");
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong restoring your recipes.");
                });
            }

            /* ===== On page load: ===== */
            display_allergens();
        </script>
    </body>
</html>
<!DOCTYPE html>
<html>
    <head>
        <title>My Pantry - RecipeBuddy</title>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" type="image/png" href="media/favicon.png">
    </head>
    <body>
        <div class="navbar">
            <a href="list.html"><div class="navbar_item">Home</div></a>
            <a href="search.html"><div class="navbar_item">Search</div></a>
            <a href="create.html"><div class="navbar_item">Create</div></a>
            <a href="pantry.html"><div class="navbar_item">Pantry</div></a>
            <a href="settings.html"><div class="navbar_item">Settings</div></a>
            <a href="help.html"><div class="navbar_item">Help</div></a>
        </div>


        <div class="app_main">
            <img class="logo" src="media/recipebuddy.png">

            <div class="content_container">
                <div class="content_inner">
                    <h1>My Pantry</h1>

                    <div class="spacer"></div>

                    <h3>Ingredients</h3>
                    <div id="INGREDIENT_LIST"></div>
                    <div class="spacer"></div>
                    <p>Add an ingredient:</p>
                    <input class="text_field" id="INGREDIENT_ADD_INPUT" placeholder="Enter ingredient name here..." onkeydown="if(event.keyCode===13) handle_add_ingredient()">
                    <button class="inline_button" onclick="handle_add_ingredient()">Add</button>

                    <div class="spacer"></div>

                    <h3>Utensils</h3>
                    <div id="UTENSIL_LIST"></div>
                    <div class="spacer"></div>
                    <p>Add a utensil:</p>
                    <input class="text_field" id="UTENSIL_ADD_INPUT" placeholder="Enter utensil name here..."onkeydown="if(event.keyCode===13) handle_add_utensil()">
                    <button class="inline_button" onclick="handle_add_utensil()">Add</button>

                </div>
            </div>
        </div>

        <div id="TOAST_MESSAGE"></div>

        <script>
            /* API url to get and post ingredients */
            const INGREDIENTS_URL = "api/ingredients"

            /* API url to get and post utensils */
            const UTENSILS_URL = "api/utensils"

            /* ===== TOAST MESSAGE ===== */
            var toast_timeout;
            /* Show toast message */
            function show_toast(message) {
                clearTimeout(toast_timeout);
                var td = document.getElementById("TOAST_MESSAGE");
                td.innerHTML = message;
                td.className = "show";
                toast_timeout = setTimeout(hide_toast, 3000);
            }
            /* Hide toast message */
            function hide_toast() {
                var td = document.getElementById("TOAST_MESSAGE");
                td.className = td.className.replace("show", "hide");
            }
            /* ===== END TOAST MESSAGE ===== */

            /* Remove an ingredient from the pantry */
            function handle_remove_ingredient(name) {
                show_toast("Removing ingredient...");
                console.log(`Handling REMOVE ingredient "${name}"`);

                /* Get current ingredients */
                fetch(INGREDIENTS_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    console.log("[DEBUG] Got data:");
                    console.log(data);
                    current_ingredients = [];
                    for(let i in data) {
                        current_ingredients.push(data[i]);
                    }
                    new_ingredients = current_ingredients.filter(function (a) {
                        return a !== name;
                    });
                    console.log(`[DEBUG] New ingredients list: ${new_ingredients}`);

                    /* Push list with removed ingredient */
                    fetch(INGREDIENTS_URL, {
                        method: "POST",
                        headers: {
                            "Accept": "application/json",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(new_ingredients),
                    }).then(async response => {
                        if(!response.ok) {
                            throw new Error("POST request failed.");
                        }
                        console.log("[DEBUG] Got data:");
                        console.log(data);

                        /* Refresh display */
                        display_ingredients();
                        show_toast("Removed ingredient.");
                    }).catch(error => {
                        console.log(error);
                        show_toast("Something went wrong removing this ingredient.");
                    });

                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong removing this ingredient.");
                });
            }

            /* Remove a utensil from the pantry */
            function handle_remove_utensil(name) {
                show_toast("Removing utensil...");
                console.log(`Handling REMOVE utensil "${name}"`);

                /* Get current utensils */
                fetch(UTENSILS_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    console.log("[DEBUG] Got data:");
                    console.log(data);
                    current_utensils = [];
                    for(let i in data) {
                        current_utensils.push(data[i]);
                    }
                    new_utensils = current_utensils.filter(function (a) {
                        return a !== name;
                    });
                    console.log(`[DEBUG] New utensils list: ${new_utensils}`);

                    /* Push list with removed utensil */
                    fetch(UTENSILS_URL, {
                        method: "POST",
                        headers: {
                            "Accept": "application/json",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(new_utensils),
                    }).then(async response => {
                        if(!response.ok) {
                            throw new Error("POST request failed.");
                        }
                        console.log("[DEBUG] Got data:");
                        console.log(data);

                        /* Refresh display */
                        display_utensils();
                        show_toast("Removed utensil.");
                    }).catch(error => {
                        console.log(error);
                        show_toast("Something went wrong removing this utensil.");
                    });

                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong removing this utensil.");
                });
            }

            /* Add an ingredient to the pantry */

            function handle_add_ingredient() {
                show_toast("Adding ingredient...");
                let ingredient_name = document.getElementById("INGREDIENT_ADD_INPUT").value;
                console.log(`Handling ADD ingredient "${ingredient_name}"`);

                /* Get current ingredients */
                fetch(INGREDIENTS_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    console.log("[DEBUG] Got data:");
                    console.log(data);
                    new_ingredients = [];
                    for(let i in data) {
                        new_ingredients.push(data[i]);
                    }
                    new_ingredients.push(ingredient_name);
                    console.log(`[DEBUG] New ingredients list: ${new_ingredients}`);

                    /* Push list with added ingredient */
                    fetch(INGREDIENTS_URL, {
                        method: "POST",
                        headers: {
                            "Accept": "application/json",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(new_ingredients),
                    }).then(async response => {
                        if(!response.ok) {
                            throw new Error("POST request failed.");
                        }
                        console.log("[DEBUG] Got data:");
                        console.log(data);

                        /* Refresh display */
                        display_ingredients();
                        show_toast("Added ingredient.");
                    }).catch(error => {
                        console.log(error);
                        show_toast("Something went wrong adding this ingredient.");
                    });

                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong adding this ingredient.");
                });
            }

            /* Add a utensil to the pantry */
            function handle_add_utensil() {
                show_toast("Adding utensil...");
                let utensil_name = document.getElementById("UTENSIL_ADD_INPUT").value;
                console.log(`Handling ADD utensil "${utensil_name}"`);

                /* Get current utensils */
                fetch(UTENSILS_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    console.log("[DEBUG] Got data:");
                    console.log(data);
                    current_utensils = [];
                    for(let i in data) {
                        current_utensils.push(data[i]);
                    }
                    current_utensils.push(utensil_name);
                    console.log(`[DEBUG] New utensils list: ${current_utensils}`);

                    /* Push list with added utensil */
                    fetch(UTENSILS_URL, {
                        method: "POST",
                        headers: {
                            "Accept": "application/json",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(current_utensils),
                    }).then(async response => {
                        if(!response.ok) {
                            throw new Error("POST request failed.");
                        }
                        console.log("[DEBUG] Got data:");
                        console.log(data);

                        /* Refresh display */
                        display_utensils();
                        show_toast("Added utensil.");
                    }).catch(error => {
                        console.log(error);
                        show_toast("Something went wrong adding this utensil.");
                    });

                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong adding this utensil.");
                });
            }
            
            /* Get and display all ingredients */
            function display_ingredients() {
                console.log("Handling DISPLAY ingredients...");
                fetch(INGREDIENTS_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    console.log("[DEBUG] Got data:");
                    console.log(data);
                    formatted_result = "";
                    for(let i in data) {
                        let ingredient = data[i];
                        console.log("[DEBUG] Processing ingredient:");
                        console.log(ingredient);
                        var ingredientHTML = `
                        <div class="pantry_entry">
                            ${ingredient}
                            <button class="pantry_button" onClick="handle_remove_ingredient('${ingredient}')">X</button>
                        </div>
                        `
                        formatted_result += ingredientHTML;
                    }

                    document.getElementById("INGREDIENT_LIST").innerHTML = formatted_result;
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong displaying your ingredients.");
                });
            }

            /* Get and display all utensils */
            function display_utensils() {
                console.log("Handling DISPLAY utensils...");
                fetch(UTENSILS_URL, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("GET request failed!");
                    }
                    const data = await response.json();
                    console.log("[DEBUG] Got data:");
                    console.log(data);
                    formatted_result = "";
                    for(let i in data) {
                        let utensil = data[i];
                        console.log("[DEBUG] Processing utensil:");
                        console.log(utensil);
                        var utensilHTML = `
                        <div class="pantry_entry">
                            ${utensil}
                            <button class="pantry_button" onClick="handle_remove_utensil('${utensil}')">X</button>
                        </div>
                        `
                        formatted_result += utensilHTML;
                    }

                    document.getElementById("UTENSIL_LIST").innerHTML = formatted_result;
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong displaying your utensils.");
                })
            }

            /* ===== On page load: ===== */
            display_ingredients();
            display_utensils();
        </script>
    </body>
</html>
<!DOCTYPE html>
<html>
    <head>
        <title>Create a Recipe - RecipeBuddy</title>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" type="image/png" href="media/favicon.png">
    </head>

    <body>
        <div class="navbar">
            <a href="list.html"><div class="navbar_item">Home</div></a>
            <a href="search.html"><div class="navbar_item">Search</div></a>
            <a href="create.html"><div class="navbar_item">Create</div></a>
            <a href="pantry.html"><div class="navbar_item">Pantry</div></a>
            <a href="settings.html"><div class="navbar_item">Settings</div></a>
            <a href="help.html"><div class="navbar_item">Help</div></a>
        </div>

        <div class="app_main">
            <img class="logo" src="media/recipebuddy.png">

            <div class="content_container">
                <div class="content_inner">
                    <h1>Creating your recipe...</h1>
                    <p>This may take a second. You'll be redirected to the recipe editor soon.</p>
                </div>
            </div>

            <div class="spacer"></div>

            <div id="SEARCH_RESULTS"></div>
        </div>

        <div id="TOAST_MESSAGE"></div>

        <script>
            const RECIPES_URL = "api/recipes"
            
            /* ===== TOAST MESSAGE ===== */
            var toast_timeout;
            /* Show toast message */
            function show_toast(message) {
                clearTimeout(toast_timeout);
                var td = document.getElementById("TOAST_MESSAGE");
                td.innerHTML = message;
                td.className = "show";
                toast_timeout = setTimeout(hide_toast, 3000);
            }
            /* Hide toast message */
            function hide_toast() {
                var td = document.getElementById("TOAST_MESSAGE");
                td.className = td.className.replace("show", "hide");
            }
            /* ===== END TOAST MESSAGE ===== */

            /* Create a recipe */
            function do_create() {
                show_toast("Creating recipe...");
                console.log("Handling CREATE recipe...");
                
                /* Assemble recipe JSON */
                const RECIPE_JSON = {
                        "id": "0",
                        "name": "New Recipe",
                        "desc": "The future home of a delicious recipe.",
                        "rating": "0.0",
                        "cooked": "0",
                        "ingredients": [],
                        "utensils": [],
                        "allergens": [],
                        "steps": [],
                        "tags": [],
                }
                
                console.log("[DEBUG] New recipe:");
                console.log(JSON.stringify(RECIPE_JSON));

                /* Send request */
                fetch(RECIPES_URL, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(RECIPE_JSON),
                }).then(async response => {
                    if(!response.ok) {
                        throw new Error("POST request failed!")
                    }
                    const data = await response.json();
                    //console.log(data);
                    show_toast("Recipe created. Taking you to the editor...");
                    window.location.href = `editor.html?id=${data.id}`;
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong creating your recipe.");
                });
            }

            /* ===== ON PAGE LOAD ===== */
            do_create();
        </script>
    </body>
</html>
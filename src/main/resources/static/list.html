<!DOCTYPE html>
<html>
    <head>
        <title>Home - RecipeBuddy</title>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" type="image/png" href="media/favicon.png">
    </head>

    <body>
        <div class="navbar_container">
            <div class="navbar">
                <a href="list.html"><div class="navbar_item">&#127968; Home</div></a>
                <a href="search.html"><div class="navbar_item">&#128270; Search</div></a>
                <a href="create.html"><div class="navbar_item">&#10133; Create</div></a>
                <a href="pantry.html"><div class="navbar_item">&#129365; Pantry</div></a>
                <a href="settings.html"><div class="navbar_item">&#128295; Settings</div></a>
                <a href="help.html"><div class="navbar_item">&#128735; Help</div></a>
            </div>
        </div>

        <div class="app_main">
            <img class="logo" src="media/recipebuddy.png">

            <div class="content_container">
                <div class="content_inner">
                    <noscript><h1>You need to enable JavaScript for Recipebuddy to work!</h1></noscript>
                    <h1 id="GREETING">Hello!</h1>
                    <p>
                        What can we help you make today?
                    </p>
                    <button class="inline_button" onclick="display_relevant_recipes()">&#127873; Show recommended recipes</button>
                    <button class="inline_button" onclick="display_all_recipes()">&#128195; Show all recipes</button>
                    <a href="search.html"><button class="inline_button">&#128270; Search for recipes</button></a>
                </div>
            </div>

            <div id="RECIPE_LIST"></div>
        </div>

        <div class="" id="TOAST_MESSAGE"></div>

        <script>
            const RECIPELIST_URL = "api/recipes"
            const SEARCH_URL = "api/search"

            /* ===== TOAST MESSAGE ===== */
            var toast_timeout;
            /* Show toast message */
            function show_toast(message) {
                clearTimeout(toast_timeout);
                var td = document.getElementById("TOAST_MESSAGE");
                td.innerHTML = message;
                td.className = "show";
                toast_timeout = setTimeout(hide_toast, 3000);
            }
            /* Hide toast message */
            function hide_toast() {
                var td = document.getElementById("TOAST_MESSAGE");
                td.className = td.className.replace("show", "hide");
            }
            /* ===== END TOAST MESSAGE ===== */

            /* ===== GREETING ===== */
            function greet() {
                const greeting = document.getElementById("GREETING");
                let d = new Date();
                let h = d.getHours();
                let intro;
                if(h < 12) {
                    greeting.innerHTML = "&#127749; Good morning!";
                } else if(h < 17) {
                    greeting.innerHTML = "&#9925; Good afternoon!";
                } else {
                    greeting.innerHTML = "&#127769; Good evening!";
                }
            }
            /* ===== END GREETING ===== */

            function show_recipes(recipe_json) {
                let formatted_result = "";
                for(let i in recipe_json) {
                    let recipe = recipe_json[i];
                    //console.log(recipe);
                    let rating_disp = "";
                    for(i = 0; i < recipe.rating; i++) {
                        rating_disp += "&#9733 ";
                        if(i > 5) { break; }
                    }
                    let recipeHTML = `
                    <div class="recipepreview_container">
                        <img class="recipepreview_photo" loading="lazy" src="api/photo/${recipe.id}">
                        <div class="recipepreview_content">
                            <h1>${recipe.name}</h1>
                            <p>${rating_disp} - Cooked ${recipe.cooked} times.</p>
                            <p>${recipe.desc}</p>
                            <a href="viewer.html?id=${recipe.id}"><div class="inline_button">&#128196; Make It</div></a>
                            <a href="editor.html?id=${recipe.id}"><div class="inline_button">&#128221; Edit</div></a>
                        </div>
                    </div>
                    `
                    formatted_result += recipeHTML;
                }
                document.getElementById("RECIPE_LIST").innerHTML = formatted_result;
                if(recipe_json.length == 0) {
                    show_toast("Couldn't find any matching recipes.");
                }
            }
            
            /* Get and display recommended recipes */
            function display_relevant_recipes() {
                console.log("Handling DISPLAY recommended recipes...");
                const SEARCH_JSON = `
                {
                    "query": "",
                    "ingredients": "SOME",
                    "utensils": "SOME",
                    "allergens": "BLOCK"
                }
                `
                fetch(SEARCH_URL, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                    },
                    body: SEARCH_JSON,
                }).then(async response => {
                    const data = await response.json();
                    //console.log(data);
                    show_toast("Showing recommended recipes.");
                    show_recipes(data);
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong fetching your recipes.");
                });  
            }

            /* Get and display all recipes */
            function display_all_recipes() {
                console.log("Handling DISPLAY all recipes...");
                const SEARCH_JSON = `
                {
                    "query": "",
                    "ingredients": "NONE",
                    "utensils": "NONE",
                    "allergens": "SHOW"
                }
                `
                fetch(SEARCH_URL, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                    },
                    body: SEARCH_JSON,
                }).then(async response => {
                    const data = await response.json();
                    //console.log(data);
                    show_recipes(data);
                    show_toast("Showing all recipes.");
                }).catch(error => {
                    console.log(error);
                    show_toast("Something went wrong fetching your recipes.");
                });  
            }
        
            /* ===== On page load: ===== */
            greet();
            display_relevant_recipes();
        </script>
    </body>
</html>